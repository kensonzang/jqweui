<!DOCTYPE html>
<html>
<head>
    <title>主页</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="lib/weui.min.css">
    <link rel="stylesheet" href="css/jquery-weui.css">
    <link rel="stylesheet" href="css/demos.css">
    <style>
        .suosou {
            margin-left: 10px;line-height: 28px;white-space: nowrap;color: #09BB07;
        }
    </style>
</head>
<body style="background-color: #f2f2f2 ">
<div class="login-tab">
    <header class='demos-header'>
        <h1 class="demos-title">登录</h1>
    </header>

    <div class="weui_cells weui_cells_form">
        <div class="weui_cell">
            <div class="weui_cell_hd"><label class="weui_label">帐号</label></div>
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input loginidtxt"  type="text" placeholder="帐号">
            </div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_hd"><label class="weui_label">密码</label></div>
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input loginpwdtxt" type="password" placeholder="密码">
            </div>
        </div>
    </div>
    <a href="javascript:;" style="width: 80%;margin-top:50px " class="weui_btn weui_btn_primary loginBtn">登录</a>
</div>
<div class="weui_tab" hidden>
    <div class="weui_tab_bd">
        <div id="tab1" class="weui_tab_bd_item weui_tab_bd_item_active">
            <div class="weui_search_bar" id="search_bar">
                <form class="weui_search_outer">
                    <div class="weui_search_inner">
                        <i class="weui_icon_search"></i>
                        <input type="search" class="weui_search_input" id="search_input" placeholder="搜索玩家" required/>
                        <a href="javascript:" class="weui_icon_clear" id="search_clear"></a>
                    </div>
                    <label for="search_input" class="weui_search_text" id="search_text">
                        <i class="weui_icon_search"></i>
                        <span>搜索玩家</span>
                    </label>
                </form>
                <a href="javascript:" class="suosou">搜索</a>
            </div>
            <div class="weui_cells weui_cells_form">
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">玩家id</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input useridtxt"  type="number" placeholder="玩家id">
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">充卡数量</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input usernumtxt" type="number" placeholder="充卡数量">
                    </div>
                </div>
                <div class="weui_cell weui_cell_select">
                    <div class="weui_cell_bd weui_cell_primary">
                        <select class="weui_select usertype">
                            <option value="roundtype_4">4圈房卡</option>
                            <option value="roundtype_8">8圈房卡</option>
                        </select>
                    </div>
                </div>
            </div>
            <a href="javascript:;" style="width: 80%;margin:20px 10% " class="weui_btn weui_btn_primary userchongBtn">充卡</a>
            <div>
                <div class="weui_panel">
                    <div class="weui_panel_hd">玩家的充卡记录</div>
                    <div class="weui_panel_bd">
                        <div class="weui_media_box weui_media_small_appmsg">
                            <div class="weui_cells userlists">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="weui-infinite-scroll userlistscroll">
                <div class="infinite-preloader"></div><!-- 菊花 -->
                正在加载... <!-- 文案，可以自行修改 -->
            </div>
        </div>
        <div id="tab2" class="weui_tab_bd_item">
            <header class='demos-header'>
                <h1 class="demos-title">增加代理</h1>
            </header>
            <div class="weui_cells weui_cells_form">
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">代理帐号</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input addidtxt"  type="text" placeholder="帐号">
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">代理密码</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input addpwdtxt" type="password" placeholder="密码">
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">代理姓名</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input addnametxt" type="text" placeholder="姓名">
                    </div>
                </div>
            </div>
            <a href="javascript:;" style="width: 80%;margin-top:50px " class="weui_btn weui_btn_primary addBtn">增加</a>
        </div>
        <div id="tab3" class="weui_tab_bd_item">
            <div class="weui_cells weui_cells_form">
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">帐号</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input ownidtxt"  type="text" disabled >
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">姓名</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input ownnametxt" type="text" disabled >
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">4圈房卡</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input own4txt" type="text" value="0张" disabled >
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">8圈房卡</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input own8txt" type="text" value="0张" disabled >
                    </div>
                </div>
            </div>
            <a href="javascript:;" style="width: 80%;margin:20px 10% " class="weui_btn weui_btn_primary chongkaBtn">为玩家充卡</a>

            <div>
                <div class="weui_panel">
                    <div class="weui_panel_hd">充卡记录</div>
                    <div class="weui_panel_bd">
                        <div class="weui_media_box weui_media_small_appmsg">
                            <div class="weui_cells owmlists">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui-infinite-scroll owmlistscroll">
                <div class="infinite-preloader"></div><!-- 菊花 -->
                正在加载... <!-- 文案，可以自行修改 -->
            </div>
        </div>
        <div id="tab4" class="weui_tab_bd_item">
            <header class='demos-header'>
                <h1 class="demos-title">充卡</h1>
            </header>
            <div class="weui_cells weui_cells_form">
                <div class="weui_cell weui_cell_select">
                    <div class="weui_cell_bd weui_cell_primary">
                        <select class="weui_select fangkatype" name="select1">
                            <option value="roundtype_4">4圈房卡</option>
                            <option value="roundtype_8">8圈房卡</option>
                        </select>
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">数量</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input numtxt" type="number"  >
                    </div>
                </div>
            </div>
            <a href="javascript:;" style="width: 80%;margin-top:50px " class="weui_btn weui_btn_primary tijiaoBtn">提交</a>
        </div>
    </div>
    <div class="weui_tabbar">
        <a href="#tab1" class="weui_tabbar_item weui_bar_item_on">
            <div class="weui_tabbar_icon">
                <i class="weui_icon_success_circle"></i>
            </div>
            <p class="weui_tabbar_label">首页</p>
        </a>
        <a href="#tab2" class="weui_tabbar_item tab2"  >
            <div class="weui_tabbar_icon">
                <i class="weui_icon_waiting"></i>
            </div>
            <p class="weui_tabbar_label">增加代理</p>
        </a>
        <a href="#tab3"  class="weui_tabbar_item tab3">
            <div class="weui_tabbar_icon">
                <i class="weui_icon_info_circle"></i>
            </div>
            <p class="weui_tabbar_label">我</p>
        </a>
        <a href="#tab4"  class="weui_tabbar_item tab4" >
            <div class="weui_tabbar_icon">
                <i class="weui_icon_info_circle"></i>
            </div>
            <p class="weui_tabbar_label">充卡</p>
        </a>
    </div>
</div>
<script src="lib/jquery-2.1.4.js"></script>
<script src="lib/fastclick.js"></script>
<script>
    $(function() {
        FastClick.attach(document.body);
    });
</script>
<script src="js/jquery-weui.js"></script>
<script>
    var httpurl="http://180.76.173.116:8080/majiang/";
    var token="";
    var user;
    var owmlist;
    var userlist;
    $(function () {
        $(".tab4").hide();
        //登录
        $(".loginBtn").click(function () {
            $.showLoading("正在登录...");
            $.ajax({ type: "post",
                url:httpurl+"admin/login",
                data:"id="+$(".loginidtxt").val()+"&pwd="+$(".loginpwdtxt").val(),
                success:function(info){
                    $.hideLoading();
                    if(info.code == "000000")
                    {
                        token=info.token;
                        user=info.user;
                        $.toast("登录成功！", 'success');
                        $(".login-tab").hide();
                        $(".weui_tab").show();
                        if(user.groups!="s")
                            $(".tab2").remove();
                        $(".ownidtxt").val(user.id);
                        $(".ownnametxt").val(user.name);
                        console.log(user);
                        $(".own4txt").val(user.id);
                        $(".own8txt").val(user.id);
                        $.showLoading("正在加载数据...");
                        $.ajax({ type: "post",
                            url:httpurl+"admin/getCardList",
                            data:"status="+"&token="+token+"&rows=1000",
                            success:function(info){
                                $.hideLoading();
                                console.log("list");
                                console.log(info);
                                if(info.rows)
                                {
                                    if(info.rows.length>0)
                                    {
                                        k=info.rows.length;
                                        owmlist=[];
                                        userlist=[];
                                        for(var i=0;i<k;i++)
                                        {
                                            if(info.rows[i].bizid)
                                                userlist.push(info.rows[i]);
                                            else
                                                owmlist.push(info.rows[i]);
                                        }
                                    }
                                }
                                console.log(userlist);
                                console.log(owmlist);
                                setList();
                            },
                            error: function () {   $.hideLoading();
                                $.toptip('连接不上服务器', 'error'); }
                        });

                    }else if(info.code == "000002"){
                        $.toptip('帐号密码错误', 'error');
                    }else
                    {
                        $.toptip(info.msg, 'error');
                    }
                },
                error: function () {
                    $.hideLoading();
                    $.toptip('连接不上服务器', 'error');
                }
            });
        })
        //增加代理
        $(".addBtn").click(function () {
            $.showLoading();
            $.ajax({ type: "post",
                url:httpurl+"admin/add",
                data:"id="+$(".addidtxt").val()+"&pwd="+$(".addpwdtxt").val()+"&name="+$(".addnametxt").val()+"&token="+token,
                success:function(info){
                    $.hideLoading();
                    if(info.code == "000000")
                    {
                        $.toast("添加成功！", 'success');
                        $(".addidtxt").val("");
                        $(".addpwdtxt").val("");
                    }else
                    {
                        $.toptip(info.msg, 'error');
                    }
                },
                error: function () {   $.hideLoading();
                    $.toptip('连接不上服务器', 'error'); }
            });
        })
        //充卡界面
        $(".chongkaBtn").click(function () {
            $(".tab4").click();
        })
        //充卡
        $(".tijiaoBtn").click(function () {
            if($(".numtxt").val()=="")
            {
                $.toptip("数量不能为空", 'error');
                return;
            }
            $.showLoading();
            $.ajax({ type: "post",
                url:httpurl+"admin/recv",
                data:"agentid="+user.id+"&num="+$(".numtxt").val()+"&type="+$(".fangkatype").val()+"&token="+token,
                success:function(info){
                    $.hideLoading();
                    if(info.code == "000000")
                    {
                        $.toast("成功！", 'success');
                        $(".numtxt").val("");
                        $(".tab3").click();
                    }else
                    {
                        $.toptip(info.msg, 'error');
                    }
                },
                error: function () {   $.hideLoading();
                    $.toptip('连接不上服务器', 'error'); }
            });
        })
        //玩家充卡
        $(".userchongBtn").click(function () {
            if($(".useridtxt").val()==""||$(".usernumtxt").val()=="")
            {
                $.toptip("玩家id和数量不能为空", 'error');
                return;
            }
            $.confirm({
                title: '提示',
                text: '确定帮玩家'+$(".useridtxt").val()+"充卡?",
                onOK: function () {
                    $.showLoading();
                    $.ajax({ type: "post",
                        url:httpurl+"admin/usecard",
                        data:"bizid="+$(".useridtxt").val()+"&num="+$(".usernumtxt").val()+"&type="+$(".usertype").val()+"&token="+token,
                        success:function(info){
                            $.hideLoading();
                            if(info.code == "000000")
                            {
                                $.toast("成功！", 'success');
                                $(".useridtxt").val("");
                                $(".usernumtxt").val("");
                            }else
                            {
                                $.toast(info.msg, 'error');
                                $.toptip(info.msg, 'error');
                            }
                        },
                        error: function () {   $.hideLoading();
                            $.toptip('连接不上服务器', 'error'); }
                    });
                },
                onCancel: function () {
                }
            });

        })
        //搜索
        $(".suosou").click(function () {
            $.alert({
                title: '玩家：2009',
                text: '昵称：dsadas   ; 十大：dasdsa   ;  十大：dasdsa   ;  ',
                onOK: function () {
                    //点击确认
                }
            });
        })
    })
    function setList(){
        $(".owmlists").children().remove();
        $(".userlists").children().remove();
        var k=owmlist.length>10?10:owmlist.length;
        for(var i=0;i<k;i++)
        {
            var leixing=owmlist[i].type=="roundtype_4"?"四圈房卡":"八圈房卡"
            var div='<div class="weui_cell"><div class="weui_cell_bd weui_cell_primary"><p>数量:'+owmlist[i].num+'</p>'+
                    '  <p>类型:'+leixing+'</p>'+
                '</div><div class="weui_cell_ft">'+owmlist[i].createTime+'</div></div>'
            $(".owmlists").append(div);
        }
        if(k==10)
        {
            $("#tab3").infinite(10).on("infinite", function() {
                if(k>=owmlist.length) {
                    $("#tab3").destroyInfinite();
                    $(".owmlistscroll").remove();
                    return;
                }
                var leixing=owmlist[k].type=="roundtype_4"?"四圈房卡":"八圈房卡"
                var div='<div class="weui_cell"><div class="weui_cell_bd weui_cell_primary"><p>数量:'+owmlist[k].num+'</p>'+
                        '  <p>类型:'+leixing+'</p>'+
                        '</div><div class="weui_cell_ft">'+owmlist[k].createTime+'</div></div>'
                $(".owmlists").append(div);
                k++;
            });
        }else
        {
            $(".owmlistscroll").remove();
        }

        var y=userlist.length>10?10:userlist.length;
        for(var i=0;i<y;i++)
        {
            var leixing=userlist[i].type=="roundtype_4"?"四圈房卡":"八圈房卡"
            var div='<div class="weui_cell"><div class="weui_cell_bd weui_cell_primary"><p>玩家id:'+userlist[i].bizid+'</p><p>数量:'+userlist[i].num+'</p>'+
                    '  <p>类型:'+leixing+'</p>'+
                    '</div><div class="weui_cell_ft">'+userlist[i].createTime+'</div></div>';

            $(".userlists").append(div);
        }
        if(y==10)
        {
            $("#tab1").infinite(10).on("infinite", function() {
                if(y>=userlist.length) {
                    $("#tab1").destroyInfinite();
                    $(".userlistscroll").remove();
                    return;
                }
                var leixing=userlist[y].type=="roundtype_4"?"四圈房卡":"八圈房卡"
                var div='<div class="weui_cell"><div class="weui_cell_bd weui_cell_primary"><p>玩家id:'+userlist[y].bizid+'</p><p>数量:'+userlist[y].num+'</p>'+
                        '  <p>类型:'+leixing+'</p>'+
                        '</div><div class="weui_cell_ft">'+userlist[y].createTime+'</div></div>';
                $(".userlists").append(div);
                y++;
            });
        }else
        {
            $(".userlistscroll").remove();
        }

    }

//    admin/login?id=aaa&pwd=aaa
//
//            admin/add?id=aaa1&pwd=aaa1&token
//                    添加代理
//
//    admin/recv?agentid=aaa&num=5&type=roundtype_4
//            回调
//
//
//    admin/usecard?token=xxxx&bizid=xxxxxxxxxxxxx&num=5&type=roundtype_4
//            给用户充卡 id卡号  userid用户
//
//    admin/getCardList?token=xxxx
//            条件可选 page 、 rows 、 id卡号  、type卡类型 、 status状态1可用 0已用、 agentid代理人  userid使用卡的用户  、时间范围 beginTime endTime测试
</script>
</body>
</html>
